<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><title>Linux中的路由表与路由策略管理 | 有涯</title><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="description" content="Linux中数据包的传输主要是路由和iptables参与的，前者决定怎样传输数据包，后者可以在路由基础上增加一些限定条件或标识（fwmark），比如iptables可以拒绝传输数据包。这次主要介绍一下路由表和路由策略管理，路由表大家接触的会比较多，但是路由策略会接触的少一些。"><link rel="canonical" href="https://blog.youya.org/2024/06/09/linux-routing-and-routing-policy/"><link rel="alternate" href="/atom.xml" title="有涯" type="application/atom+xml"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 7.3.0"></head><body class="body"><div class="container container--outer"><header class="header"><div class="container"><div class="logo"><a class="logo__link" href="/" title="有涯" rel="home"><div class="logo__title">有涯</div><div class="logo__tagline">行到水穷处，坐看云起时</div></a></div><nav class="menu"><button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0"><span class="menu__btn-title" tabindex="-1">Menu</span></button><ul class="menu__list"><li class="menu__item"><a class="menu__link" href="/"><span class="menu__text">Home</span></a></li><li class="menu__item"><a class="menu__link" href="/about/"><span class="menu__text">About</span></a></li><li class="menu__item"><a class="menu__link" href="/archives/"><span class="menu__text">Archives</span></a></li><li class="menu__item"><a class="menu__link" href="/brokers/"><span class="menu__text">Brokers</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class="primary"><main class="main" role="main"><article class="post"><header class="post__header"><h1 class="post__title">Linux中的路由表与路由策略管理</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg> <time class="meta__text" datetime="2024-06-09">2024-06-09</time></div></div></header><div class="content post__content clearfix"><p>Linux中数据包的传输主要是路由和iptables参与的，前者决定怎样传输数据包，后者可以在路由基础上增加一些限定条件或标识（fwmark），比如iptables可以拒绝传输数据包。这次主要介绍一下路由表和路由策略管理，路由表大家接触的会比较多，但是路由策略会接触的少一些。</p><span id="more"></span><h2 id="路由表"><a href="#路由表" class="headerlink" title="路由表"></a>路由表</h2><p>路由表通常由<code>ip route</code>命令管理，也通过使用<code>route -n</code>和<code>netstat -nr</code>来管理与查看，不过<code>route</code>与<code>netstat</code>已经是过去式了，现在及以后都要用由<code>iproute2</code>软件包提供的<code>ip</code>命令来管理。</p><pre><code class="hljs plaintext">$ ip route show
default via 192.168.249.1 dev wlp1s0 proto dhcp src 192.168.249.68 metric 600
192.168.249.0/24 dev wlp1s0 proto kernel scope link src 192.168.249.68 metric 600</code></pre><p>以上是我电脑上的路由表信息，可以看到包含两条路由。在前面添加<code>ip route add</code>或<code>ip route del</code>就是添加或删除路由了，如下：</p><pre><code class="hljs plaintext">ip route add 10.0.0.0/8 via 192.168.249.1

ip route del 10.0.0.0/8 via 192.168.249.1</code></pre><p>其实以上只是管理机器上的「主路由表」，默认情况下机器上有三张路由表的分别是<code>local</code>、<code>main</code>、<code>default</code>，而这些路由表配合路由策略共同决定了数据包应该怎样传输。</p><p>平时大家操作的都是<code>main</code>路由表，以上命令后面都是省略了<code>table main</code>，比如：</p><pre><code class="hljs plaintext">ip route show table main</code></pre><p>查看数据包路由规则：</p><pre><code class="hljs plaintext">ip route get 1.1.1.1

ip route get 223.5.5.5 dport 53</code></pre><h2 id="路由策略"><a href="#路由策略" class="headerlink" title="路由策略"></a>路由策略</h2><p>上面说了默认情况下主机上有三张路由表，当然用户也可以自主创建路由表，那么要实现路由表的优先级及更精细化的路由控制就需要路由策略了。简单来说路由策略可以按端口、协议、用户UID区间、fwmark等来控制数据包路由。</p><p>路由策略由<code>ip rule</code>命令进行管理，默认情况下机器上有三条路由策略：</p><pre><code class="hljs plaintext">$ ip rule list
0:      from all lookup local
32766:  from all lookup main
32767:  from all lookup default</code></pre><p>第一列为优先级，后面是路由策略，就是控制什么样的数据包走哪张路由表。下面举例说明：</p><ol><li><p>创建一个路由表及路由规则：</p><pre><code class="hljs plaintext">ip route add 10.0.0.0/8 via 192.168.249.1 table 12345

ip route show table 12345</code></pre></li><li><p>创建一个路由策略，使其优先级高于「主路由表」：</p><pre><code class="hljs plaintext">ip rule add from all priority 5555 table 12345

ip rule list</code></pre></li></ol><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><p>路由策略的一个使用场景就是VPN做数据包分流，拿Clash来举例（WireGuard也类似），开启Tun及Auto Route功能后，会在系统中添加相应的路由表与路由策略。</p><p>主路由表会增加<code>fake-ip</code>网段走<code>utun</code>设备的路由规则：</p><pre><code class="hljs plaintext">$ ip route show
default via 192.168.249.1 dev wlp1s0 proto dhcp src 192.168.249.68 metric 600
192.168.249.0/24 dev wlp1s0 proto kernel scope link src 192.168.249.68 metric 600
198.18.0.0/16 dev utun proto kernel scope link src 198.18.0.1</code></pre><p>路由策略会增加四条优先级分别为<code>9500</code>、<code>9510</code>、<code>9520</code>、<code>9530</code>：</p><pre><code class="hljs plaintext">$ ip rule list
0:      from all lookup local
9500:   not from all dport 53 lookup main suppress_prefixlength 0
9510:   not from all iif lo lookup 1970566510
9520:   from 0.0.0.0 iif lo uidrange 0-4294967294 lookup 1970566510
9530:   from 198.18.0.1 iif lo uidrange 0-4294967294 lookup 1970566510
32766:  from all lookup main
32767:  from all lookup default</code></pre><p>由路由策略可以看出还会增加一个路由表<code>1970566510</code>，内容就是数据包默认走<code>utun</code>设备：</p><pre><code class="hljs plaintext">$ ip route show table 1970566510
default dev utun proto static</code></pre><p>下面讲解一下Clash新增的这四条路由策略：</p><ol><li><p><code>9500: not from all dport 53 lookup main suppress_prefixlength 0</code></p><p>所有目的端口不是53的数据包都走<code>main</code>路由表，但不包含<code>main</code>路由表中的默认路由。</p><p>解释一下，53是DNS服务端口，目的端口不是53表示「非DNS查询数据包」；<code>suppress_prefixlength 0</code>意思是忽略<code>prefix</code>长度为0的数据包，就是忽略<code>0.0.0.0/0</code>的数据包，<code>0.0.0.0/0</code>表示所有IP。本机内网路由一般都显式指定，所以综合以上，该规则的意思是：<strong>所有非DNS查询并且非内网的数据包都走「主路由表」，就是内网流量照常路由</strong>。</p></li><li><p><code>9510: not from all iif lo lookup 1970566510</code></p><p>所有输入网卡不是<code>lo</code>的数据包都走<code>1970566510</code>路由表，即排除掉本地生成的包含源地址的数据包之外的数据包都走路由表<code>1970566510</code>。当本机作为网关时，其他机器的内网流量不走Clash。</p></li><li><p><code>9520: from 0.0.0.0 iif lo uidrange 0-4294967294 lookup 1970566510</code></p><p><code>from 0.0.0.0 iif lo</code>意思是本地生成的不包含源地址的数据包，在Linux中当客户端生成的数据包没到达网卡前是没法包含源地址的，这条策略的意思就是本机数据包要走Clash。</p></li><li><p><code>9530: from 198.18.0.1 iif lo uidrange 0-4294967294 lookup 1970566510</code></p><p>所有从<code>198.18.0.1</code>过来的数据包都走路由表<code>1970566510</code>，<code>198.18.0.1</code>为<code>fake-ip</code>网段的网关，该条策略和「主路由表」中的那条<code>fake-ip</code>走<code>utun</code>设备的路由一起配合工作。</p></li></ol><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="http://linux-ip.net/html/tools-ip-rule.html" target="_blank" rel="noopener external nofollow noreferrer">http://linux-ip.net/html/tools-ip-rule.html</a></li><li><a href="http://linux-ip.net/html/tools-ip-route.html" target="_blank" rel="noopener external nofollow noreferrer">http://linux-ip.net/html/tools-ip-route.html</a></li><li><a href="https://breakertt.moe/2023/04/02/clash_auto-route/" target="_blank" rel="noopener external nofollow noreferrer">https://breakertt.moe/2023/04/02/clash_auto-route/</a></li></ul></div><footer class="post__footer"><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg><ul class="tags__list"><li class="tags__item"><a class="tags__link btn" href="/tags/tech/" rel="tag">Tech</a></li><li class="tags__item"><a class="tags__link btn" href="/tags/linux/" rel="tag">Linux</a></li><li class="tags__item"><a class="tags__link btn" href="/tags/iproute/" rel="tag">iproute</a></li><li class="tags__item"><a class="tags__link btn" href="/tags/route/" rel="tag">route</a></li><li class="tags__item"><a class="tags__link btn" href="/tags/proxy/" rel="tag">Proxy</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class="pager__link" href="/2024/07/06/layer-2-network/" rel="prev"><span class="pager__subtitle">«&thinsp;Previous</span><p class="pager__title">闲话大二层网络</p></a></div><div class="pager__item pager__item--next"><a class="pager__link" href="/2024/05/18/year-end-bonus-tax/" rel="next"><span class="pager__subtitle">Next&thinsp;»</span><p class="pager__title">奇葩的年终奖税收政策导致年终奖黑洞</p></a></div></nav><section class="comments"><div id="tcomment"></div><script src="https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js"></script><script>twikoo.init({envId:"https://blog-comments.youya.org",el:"#tcomment",path:"/2024/06/09/linux-routing-and-routing-policy/",lang:"zh-CN"})</script></section></div><aside class="sidebar"><div class="widget-search widget"><form class="widget-search__form" role="search" method="get" action="https://google.com/search" target="_blank"><input class="widget-search__field" type="search" placeholder="Search..." name="q" aria-label="Search..."> <input class="widget-search__submit" type="submit" value="Search"> <input type="hidden" name="sitesearch" value="https://blog.youya.org"></form></div><div class="widget-ads widget"><h4 class="widget__title">Google Ads</h4><div class="widget__content"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5700774973519770" crossorigin="anonymous"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5700774973519770" data-ad-slot="1935557915" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class="widget-related widget"><h4 class="widget__title">Related Posts</h4><div class="widget__content"><ul class="widget__list"><li class="widget__item"><a class="widget__link" href="/2022/07/22/install-and-use-archlinux/">安装和使用Archlinux</a></li><li class="widget__item"><a class="widget__link" href="/2021/08/07/windows-vs-linux/">Windows vs Linux</a></li><li class="widget__item"><a class="widget__link" href="/2020/12/20/yoga-14s-installs-deepin-os/">联想 Yoga 14s 2021 锐龙版安装 Deepin 操作系统</a></li><li class="widget__item"><a class="widget__link" href="/2024/07/06/layer-2-network/">闲话大二层网络</a></li><li class="widget__item"><a class="widget__link" href="/2024/04/27/podman-manages-vms/">Podman管理虚拟机</a></li></ul></div></div><div class="widget-recent widget"><h4 class="widget__title">Recent Posts</h4><div class="widget__content"><ul class="widget__list"><li class="widget__item"><a class="widget__link" href="/2024/07/14/poor-china-economy/">繁华渐逝：腹背受敌的中国经济</a></li><li class="widget__item"><a class="widget__link" href="/2024/07/06/layer-2-network/">闲话大二层网络</a></li><li class="widget__item"><a class="widget__link" href="/2024/06/09/linux-routing-and-routing-policy/">Linux中的路由表与路由策略管理</a></li><li class="widget__item"><a class="widget__link" href="/2024/05/18/year-end-bonus-tax/">奇葩的年终奖税收政策导致年终奖黑洞</a></li><li class="widget__item"><a class="widget__link" href="/2024/04/27/podman-manages-vms/">Podman管理虚拟机</a></li></ul></div></div><div class="widget-taglist widget"><h4 class="widget__title">Tag Cloud</h4><div class="widget__content"><a href="/tags/android/" style="font-size:26px">Android</a> <a href="/tags/apps/" style="font-size:18px">Apps</a> <a href="/tags/archlinux/" style="font-size:14px">Archlinux</a> <a href="/tags/bank/" style="font-size:14px">Bank</a> <a href="/tags/bash/" style="font-size:14px">Bash</a> <a href="/tags/blog/" style="font-size:26px">Blog</a> <a href="/tags/bond/" style="font-size:14px">Bond</a> <a href="/tags/cloudflare/" style="font-size:14px">CloudFlare</a> <a href="/tags/comics/" style="font-size:14px">Comics</a> <a href="/tags/commissions/" style="font-size:14px">Commissions</a> <a href="/tags/container/" style="font-size:22px">Container</a> <a href="/tags/cube/" style="font-size:22px">Cube</a> <a href="/tags/deepin/" style="font-size:14px">Deepin</a> <a href="/tags/docker/" style="font-size:22px">Docker</a> <a href="/tags/etf/" style="font-size:14px">ETF</a> <a href="/tags/economy/" style="font-size:14px">Economy</a> <a href="/tags/email/" style="font-size:14px">Email</a> <a href="/tags/fx/" style="font-size:14px">FX</a> <a href="/tags/firstrade/" style="font-size:14px">Firstrade</a> <a href="/tags/fund/" style="font-size:18px">Fund</a> <a href="/tags/futu/" style="font-size:18px">Futu</a> <a href="/tags/futures/" style="font-size:14px">Futures</a> <a href="/tags/google/" style="font-size:14px">Google</a> <a href="/tags/greenify/" style="font-size:14px">Greenify</a> <a href="/tags/hexo/" style="font-size:14px">Hexo</a> <a href="/tags/ibkr/" style="font-size:18px">IBKR</a> <a href="/tags/icbc/" style="font-size:14px">ICBC</a> <a href="/tags/iaas/" style="font-size:14px">IaaS</a> <a href="/tags/kubernetes/" style="font-size:26px">Kubernetes</a> <a href="/tags/life/" style="font-size:14px">Life</a> <a href="/tags/linux/" style="font-size:26px">Linux</a> <a href="/tags/longbridge/" style="font-size:14px">Longbridge</a> <a href="/tags/magisk/" style="font-size:14px">Magisk</a> <a href="/tags/mariadb/" style="font-size:14px">MariaDB</a> <a href="/tags/mysql/" style="font-size:14px">MySQL</a> <a href="/tags/network/" style="font-size:14px">Network</a> <a href="/tags/nginx/" style="font-size:14px">Nginx</a> <a href="/tags/oneplus/" style="font-size:14px">OnePlus</a> <a href="/tags/openssl/" style="font-size:14px">OpenSSL</a> <a href="/tags/option/" style="font-size:18px">Option</a> <a href="/tags/php/" style="font-size:14px">PHP</a> <a href="/tags/podman/" style="font-size:18px">Podman</a> <a href="/tags/postfix/" style="font-size:14px">Postfix</a> <a href="/tags/proxy/" style="font-size:14px">Proxy</a> <a href="/tags/python/" style="font-size:14px">Python</a> <a href="/tags/repost/" style="font-size:30px">Repost</a> <a href="/tags/rubik/" style="font-size:14px">Rubik</a> <a href="/tags/shell/" style="font-size:18px">Shell</a> <a href="/tags/stock/" style="font-size:30px">Stock</a> <a href="/tags/systemd/" style="font-size:14px">Systemd</a></div></div></aside></div><footer class="footer"><div class="container footer__container flex"><div class="footer__copyright">&copy; 2025 YOUYA.ORG. <span class="footer__copyright-credits">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.</span></div></div></footer></div><script src="/js/menu.js"></script></body></html>