<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><title>Kubernetes 权限控制 | 有涯</title><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name="description" content="权限控制离不开用户管理系统、认证和授权，下面就简单讲一下这三个概念。
用户管理系统，一般存放着用户的相关信息，最主要的有用户名、用户密码和用户组。
认证（Authentication, AuthN）主要是验证用户的合法性，比如用户名和密码正确即认证成功。
授权（Authorization, AuthZ）主要是验证用户是否有权限来做某事，通常可以给单个用户某些权限，也可以给用户组某些权限，在该用户组里的用户会继承这些权限。
Kubernetes 里的权限控制有三种方式，分别是 RBAC, ABAC, Webhook。"><link rel="canonical" href="https://blog.youya.org/2022/10/22/kubernetes-access-control/"><link rel="alternate" href="/atom.xml" title="有涯" type="application/atom+xml"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 7.3.0"></head><body class="body"><div class="container container--outer"><header class="header"><div class="container"><div class="logo"><a class="logo__link" href="/" title="有涯" rel="home"><div class="logo__title">有涯</div><div class="logo__tagline">行到水穷处，坐看云起时</div></a></div><nav class="menu"><button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0"><span class="menu__btn-title" tabindex="-1">Menu</span></button><ul class="menu__list"><li class="menu__item"><a class="menu__link" href="/"><span class="menu__text">Home</span></a></li><li class="menu__item"><a class="menu__link" href="/about/"><span class="menu__text">About</span></a></li><li class="menu__item"><a class="menu__link" href="/archives/"><span class="menu__text">Archives</span></a></li><li class="menu__item"><a class="menu__link" href="/brokers/"><span class="menu__text">Brokers</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class="primary"><main class="main" role="main"><article class="post"><header class="post__header"><h1 class="post__title">Kubernetes 权限控制</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg> <time class="meta__text" datetime="2022-10-22">2022-10-22</time></div></div></header><div class="content post__content clearfix"><p>权限控制离不开用户管理系统、认证和授权，下面就简单讲一下这三个概念。</p><p>用户管理系统，一般存放着用户的相关信息，最主要的有用户名、用户密码和用户组。</p><p>认证（Authentication, AuthN）主要是验证用户的合法性，比如用户名和密码正确即认证成功。</p><p>授权（Authorization, AuthZ）主要是验证用户是否有权限来做某事，通常可以给单个用户某些权限，也可以给用户组某些权限，在该用户组里的用户会继承这些权限。</p><p>Kubernetes 里的权限控制有三种方式，分别是 RBAC, ABAC, Webhook。</p><span id="more"></span><h2 id="RBAC-Role-Based-Access-Control"><a href="#RBAC-Role-Based-Access-Control" class="headerlink" title="RBAC - Role Based Access Control"></a>RBAC - Role Based Access Control</h2><p>RBAC 权限控制是 Kubernetes 主推的方式，RBAC 本身也是使用比较广泛的。</p><p>在 Kubernetes 中，RBAC 三要素： Can <strong>主体subject</strong> <strong>动词verb</strong> <strong>目标object</strong> ?</p><p>比如：Can Alice create pod?</p><p>Subject 分为 User、Group、ServiceAccount，其中：</p><ul><li>User 为用户，Kubernetes 对用户格式没要求，字符串都可以，比如 <code>Alice</code> 就是一个用户。</li><li>Group 为组，可以是用户组，也可以是 ServiceAccount 组。</li><li>ServiceAccount 为服务账户，比如用户创建的 Pod 里运行的程序再调用 Kubernetes API 创建资源时所使用的账户就叫 ServiceAccount。</li></ul><p>Kubernetes 预留了<code>system:</code>开头的组作为特殊用途，有以下几类：</p><ul><li>system:serviceaccounts 代表系统里的所有 ServiceAccount</li><li>system:serviceaccounts:ns1 代表 ns1 namesapce 下的所有 ServiceAccount</li><li>system:autenticated 代表所有已登录用户</li><li>system:unauthenticated 代表所有未登录用户</li></ul><p>Verb 内置的主要有 create、get、list、watch、update、patch、delete，用户还可以自定义各种动词，比如 eat、wear、live、use等。</p><p>Object 就是 Kubernetes 资源，包含内置的资源，比如 Deployment、Service、Pod 等，和自定义的资源。</p><p>Subject、Verb、Object 是通过 Role&#x2F;Rolebinding 来组织到一起进行工作的。</p><h3 id="Role-ClusterRole"><a href="#Role-ClusterRole" class="headerlink" title="Role&#x2F;ClusterRole"></a>Role&#x2F;ClusterRole</h3><p>Role&#x2F;ClusterRole 中定义了 Verb 和 Object，意思为能做什么，比如 创建 Pod、查看 Service 等。</p><p>Role 必须定义在某个 namespace 里面并且所操作的资源必须是 namespace 级别的，ClusterRole 既可以定义集群级别的资源也可以定义 Namespace 级别的资源。</p><p>Role 只能被 Rolebinding 所绑定，ClusterRole 既可以被 Rolebinding 绑定又可以被 ClusterRoleBinding 绑定。</p><p>当 ClusterRole 被 RoleBinding 绑定时表示某个主体（Subject）可以在某个 namespace 里做什么，比如 Alice 可以在 ns1 namespace 里创建 Pod。</p><p>当 ClusterRole 被 ClusterRoleBinding 绑定时表示某个主体（Subject）可以在整个集群中里做什么，比如 Alice 可以在任意 namespace 里创建 Pod。</p><p>Role 示例，可以在 ns1 里创建 Pod：</p><pre><code class="hljs plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: create-pod
  namespace: ns1
rules:
  - apiGroups: [&quot;v1&quot;]
    resources: [&quot;pods&quot;]
    verbs: [&quot;create&quot;]</code></pre><p>ClusterRole 示例，可以在所有 namespace 里创建 Pod 和创建集群资源 PersistenVolume：</p><pre><code class="hljs plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: create-pod
rules:
  - apiGroups: [&quot;v1&quot;]
    resources: [&quot;pods&quot;, &quot;persistentvolumes&quot;]
    verbs: [&quot;create&quot;]</code></pre><h3 id="Rolebinding-ClusterRoleBinding"><a href="#Rolebinding-ClusterRoleBinding" class="headerlink" title="Rolebinding&#x2F;ClusterRoleBinding"></a>Rolebinding&#x2F;ClusterRoleBinding</h3><p>Rolebinding&#x2F;ClusterRoleBinding 就是将 Subject 与 Verb 和 Object 绑定到一起，作用是指定<strong>谁</strong>能做什么。</p><p>RoleBinding 示例，Alice 可以在 ns1 里创建 Pod：</p><pre><code class="hljs plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: alice-create-pod
  namespace: ns1
subjects:
  - kind: User
    name: Alice
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: create-pod
  apiGroup: rbac.authorization.k8s.io</code></pre><p>ClusterRoleBinding 示例，Alice 可以在任意 namespace 里创建 Pod 和集群资源 PersistentVolume：</p><pre><code class="hljs plaintext">apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: alice-create-pod
subjects:
  - kind: User
    name: Alice
    apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: create-pod
  apiGroup: rbac.authorization.k8s.io</code></pre><h2 id="ABAC-Attribute-Based-Access-Control"><a href="#ABAC-Attribute-Based-Access-Control" class="headerlink" title="ABAC - Attribute Based Access Control"></a>ABAC - Attribute Based Access Control</h2><p>ABAC 是通过将属性组合在一起的策略来授予用户权限，需要在 Kuberentes Apiserver 启动时指定一个静态的策略文件，使用起来不够灵活并且目录处于 Beta 状态，近几年几乎没什么改动，用户比较少。</p><p>下面就是一个示例，表示 Alice 可以在 namespace ns1 里管理 Pod：</p><pre><code class="hljs plaintext">&#123;&quot;apiVersion&quot;: &quot;abac.authorization.kubernetes.io/v1beta1&quot;, &quot;kind&quot;: &quot;Policy&quot;, &quot;spec&quot;: &#123;&quot;user&quot;: &quot;alice&quot;, &quot;namespace&quot;: &quot;ns1&quot;, &quot;resource&quot;: &quot;pods&quot;, &quot;apiGroup&quot;: &quot;v1&quot;&#125;&#125;</code></pre><p>Namespace ns1 里的 ServiceAccount sa1 可以管理 Pod：</p><pre><code class="hljs plaintext">&#123;&quot;apiVersion&quot;: &quot;abac.authorization.kubernetes.io/v1beta1&quot;, &quot;kind&quot;: &quot;Policy&quot;, &quot;spec&quot;: &#123;&quot;user&quot;: &quot;system:serviceaccount:ns1:sa1&quot;, &quot;namespace&quot;: &quot;ns1&quot;, &quot;resource&quot;: &quot;pods&quot;, &quot;apiGroup&quot;: &quot;v1&quot;&#125;&#125;</code></pre><h2 id="Webhook"><a href="#Webhook" class="headerlink" title="Webhook"></a>Webhook</h2><p>Webhook 是将授权放到外部一个服务上去，每当某个用户要对 Kubernetes 进行操作时，都先去外部服务上问一下是否有权限，只有有权限时才允许操作。</p><h2 id="RBAC-模式下系统内置的-ClusterRole"><a href="#RBAC-模式下系统内置的-ClusterRole" class="headerlink" title="RBAC 模式下系统内置的 ClusterRole"></a>RBAC 模式下系统内置的 ClusterRole</h2><p>Kubernetes 系统会内置一系列 ClusterRole 供用户和其自己核心组件使用，下面主要说一下面向用户的 ClusterRole。</p><ul><li>cluster-admin 即集群管理员，可以用 ClusterRoleBinding 将其绑定给某个用户，表示这个用户为可以在集群中做任何事情。</li><li>admin 即管理员，可以用某个 Namespace 里的 RoleBinding 将其绑定给某个用户，表示该用户是该 Namespace 的管理员。</li><li>edit 即编辑，可以用某个 Namespace 里的 RoleBinding 将其绑定给某个用户，表示该用户是该 Namespace 的编辑。</li><li>view 即查阅者，可以用某个 Namespace 里的 RoleBinding 将其绑定给某个用户，表示该用户是该 Namespace 的查阅者。</li></ul><p>通常如果 Kubernetes 集群里只使用其核心资源的话，以上权限足够了，但是想要使用自定义资源并且更细粒度的控制权限，就需要用到 Aggregated ClusterRole 了。</p><h2 id="Aggregated-ClusterRole"><a href="#Aggregated-ClusterRole" class="headerlink" title="Aggregated ClusterRole"></a>Aggregated ClusterRole</h2><p>用户可以创建一个 Aggregated ClusterRole 并指定 Label Selector，当这个 Aggregated ClusterRole 被绑定到某个用户时，那么该用户也会拥有这个 Label 的其他 ClusterRole 权限。</p><h2 id="自定义-Verb-和-Object"><a href="#自定义-Verb-和-Object" class="headerlink" title="自定义 Verb 和 Object"></a>自定义 Verb 和 Object</h2><p>除了内置的 Verb 和 Object 之外，用户还可以自定义 Verb 与 Object 并实现自己的逻辑，比如：Can Alice Ride Bike。</p><p>后续写 Kubernetes CSI 存储端到端的多租户时会详细说明一下。</p></div><footer class="post__footer"><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg><ul class="tags__list"><li class="tags__item"><a class="tags__link btn" href="/tags/tech/" rel="tag">Tech</a></li><li class="tags__item"><a class="tags__link btn" href="/tags/kubernetes/" rel="tag">Kubernetes</a></li><li class="tags__item"><a class="tags__link btn" href="/tags/rbac/" rel="tag">rbac</a></li></ul></div></footer></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class="pager__link" href="/2022/10/23/kubernetes-csi-storage-e2e-multi-tenant/" rel="prev"><span class="pager__subtitle">«&thinsp;Previous</span><p class="pager__title">Kubernetes CSI 存储端到端多租户隔离</p></a></div><div class="pager__item pager__item--next"><a class="pager__link" href="/2022/10/16/kubernetes-authn/" rel="next"><span class="pager__subtitle">Next&thinsp;»</span><p class="pager__title">Kubernetes 认证系统</p></a></div></nav><section class="comments"><div id="tcomment"></div><script src="https://registry.npmmirror.com/twikoo/1.6.39/files/dist/twikoo.min.js"></script><script>twikoo.init({envId:"https://blog-comments.youya.org",el:"#tcomment",path:"/2022/10/22/kubernetes-access-control/",lang:"zh-CN"})</script></section></div><aside class="sidebar"><div class="widget-search widget"><form class="widget-search__form" role="search" method="get" action="https://google.com/search" target="_blank"><input class="widget-search__field" type="search" placeholder="Search..." name="q" aria-label="Search..."> <input class="widget-search__submit" type="submit" value="Search"> <input type="hidden" name="sitesearch" value="https://blog.youya.org"></form></div><div class="widget-ads widget"><h4 class="widget__title">Google Ads</h4><div class="widget__content"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5700774973519770" crossorigin="anonymous"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5700774973519770" data-ad-slot="1935557915" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div><div class="widget-related widget"><h4 class="widget__title">Related Posts</h4><div class="widget__content"><ul class="widget__list"><li class="widget__item"><a class="widget__link" href="/2022/10/23/kubernetes-csi-storage-e2e-multi-tenant/">Kubernetes CSI 存储端到端多租户隔离</a></li><li class="widget__item"><a class="widget__link" href="/2022/10/16/kubernetes-authn/">Kubernetes 认证系统</a></li><li class="widget__item"><a class="widget__link" href="/2019/08/31/podman-is-a-good-docker-alternative/">Podman - 一个 Docker 的替代软件</a></li><li class="widget__item"><a class="widget__link" href="/2024/07/06/layer-2-network/">闲话大二层网络</a></li><li class="widget__item"><a class="widget__link" href="/2024/06/09/linux-routing-and-routing-policy/">Linux中的路由表与路由策略管理</a></li></ul></div></div><div class="widget-recent widget"><h4 class="widget__title">Recent Posts</h4><div class="widget__content"><ul class="widget__list"><li class="widget__item"><a class="widget__link" href="/2024/07/14/poor-china-economy/">繁华渐逝：腹背受敌的中国经济</a></li><li class="widget__item"><a class="widget__link" href="/2024/07/06/layer-2-network/">闲话大二层网络</a></li><li class="widget__item"><a class="widget__link" href="/2024/06/09/linux-routing-and-routing-policy/">Linux中的路由表与路由策略管理</a></li><li class="widget__item"><a class="widget__link" href="/2024/05/18/year-end-bonus-tax/">奇葩的年终奖税收政策导致年终奖黑洞</a></li><li class="widget__item"><a class="widget__link" href="/2024/04/27/podman-manages-vms/">Podman管理虚拟机</a></li></ul></div></div><div class="widget-taglist widget"><h4 class="widget__title">Tag Cloud</h4><div class="widget__content"><a href="/tags/android/" style="font-size:26px">Android</a> <a href="/tags/apps/" style="font-size:18px">Apps</a> <a href="/tags/archlinux/" style="font-size:14px">Archlinux</a> <a href="/tags/bank/" style="font-size:14px">Bank</a> <a href="/tags/bash/" style="font-size:14px">Bash</a> <a href="/tags/blog/" style="font-size:26px">Blog</a> <a href="/tags/bond/" style="font-size:14px">Bond</a> <a href="/tags/cloudflare/" style="font-size:14px">CloudFlare</a> <a href="/tags/comics/" style="font-size:14px">Comics</a> <a href="/tags/commissions/" style="font-size:14px">Commissions</a> <a href="/tags/container/" style="font-size:22px">Container</a> <a href="/tags/cube/" style="font-size:22px">Cube</a> <a href="/tags/deepin/" style="font-size:14px">Deepin</a> <a href="/tags/docker/" style="font-size:22px">Docker</a> <a href="/tags/etf/" style="font-size:14px">ETF</a> <a href="/tags/economy/" style="font-size:14px">Economy</a> <a href="/tags/email/" style="font-size:14px">Email</a> <a href="/tags/fx/" style="font-size:14px">FX</a> <a href="/tags/firstrade/" style="font-size:14px">Firstrade</a> <a href="/tags/fund/" style="font-size:18px">Fund</a> <a href="/tags/futu/" style="font-size:18px">Futu</a> <a href="/tags/futures/" style="font-size:14px">Futures</a> <a href="/tags/google/" style="font-size:14px">Google</a> <a href="/tags/greenify/" style="font-size:14px">Greenify</a> <a href="/tags/hexo/" style="font-size:14px">Hexo</a> <a href="/tags/ibkr/" style="font-size:18px">IBKR</a> <a href="/tags/icbc/" style="font-size:14px">ICBC</a> <a href="/tags/iaas/" style="font-size:14px">IaaS</a> <a href="/tags/kubernetes/" style="font-size:26px">Kubernetes</a> <a href="/tags/life/" style="font-size:14px">Life</a> <a href="/tags/linux/" style="font-size:26px">Linux</a> <a href="/tags/longbridge/" style="font-size:14px">Longbridge</a> <a href="/tags/magisk/" style="font-size:14px">Magisk</a> <a href="/tags/mariadb/" style="font-size:14px">MariaDB</a> <a href="/tags/mysql/" style="font-size:14px">MySQL</a> <a href="/tags/network/" style="font-size:14px">Network</a> <a href="/tags/nginx/" style="font-size:14px">Nginx</a> <a href="/tags/oneplus/" style="font-size:14px">OnePlus</a> <a href="/tags/openssl/" style="font-size:14px">OpenSSL</a> <a href="/tags/option/" style="font-size:18px">Option</a> <a href="/tags/php/" style="font-size:14px">PHP</a> <a href="/tags/podman/" style="font-size:18px">Podman</a> <a href="/tags/postfix/" style="font-size:14px">Postfix</a> <a href="/tags/proxy/" style="font-size:14px">Proxy</a> <a href="/tags/python/" style="font-size:14px">Python</a> <a href="/tags/repost/" style="font-size:30px">Repost</a> <a href="/tags/rubik/" style="font-size:14px">Rubik</a> <a href="/tags/shell/" style="font-size:18px">Shell</a> <a href="/tags/stock/" style="font-size:30px">Stock</a> <a href="/tags/systemd/" style="font-size:14px">Systemd</a></div></div></aside></div><footer class="footer"><div class="container footer__container flex"><div class="footer__copyright">&copy; 2025 YOUYA.ORG. <span class="footer__copyright-credits">Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.</span></div></div></footer></div><script src="/js/menu.js"></script></body></html>